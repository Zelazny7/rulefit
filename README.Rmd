---
title: "README"
author: "Eric Graves"
date: "July 10, 2017"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rulefit)
data(titanic, package="binnr")
```

## Installation

```{r install, eval=FALSE}
devtools::install_git("https://GravesEE@gitlab.ins.risk.regn.net/minneapolis-r-packages/rulefit.git")
```

## Usage

### Creating a RuleFit Model

A RuleFit model uses a tree ensemble to generate its rules. As such, a tree 
ensemble model must be provided to the rulefit function. This funciton returns
a RuleFit object which can be used to mine rules and train rule ensembles.

```{r constructor, warning=FALSE}

mod <- gbm.fit(titanic[-1], titanic$Survived, distribution="bernoulli",
  interaction.depth=3, shrinkage=0.1, verbose = FALSE)

rf <- rulefit(mod)

class(rf)
```

### Training

Training a RuleFit model is as easy as calling the train method. This is a
Reference Class object like those in `binnr` which means functions are
"attached" to the object itself. The train method uses the `cv.glmnet` function
from the `glmnet` package and accepts all of the same arguments.

##### Common Arguments
Argument | Purpose
---|---
x | Dataset of predictors that should match what was used for training the ensemble.
y | Target variable to train against.
family | What is the distribution of the target? Binomial for 0/1 variables.
keep | TRUE/FALSE for whether to keep the out-of-fold predictions. Useful for validation.
alpha | Penatly mixing parameter. LASSO regression uses the default of 0.
nfolds | How many k-folds to train the model with. Defaults to 5.
dfmax | How many variables should the final model have?

```{r train}
rf$train(x=titanic[-1], y = titanic$Survived, family="binomial", keep=TRUE, nfolds=10)
```

The train method first creates hundreds of rules from the tree ensemble. Each
rule is a path through a single decision tree and represents the conjunction
of logical statments. Here are a few of the candidate rules printed in pseudo-
code.

```{r}
head(rf$rules, 1)

tail(rf$rules, 1)
```

### Predicting

Once a RuleFit model is trained. Predictions can be produced by calling the 
predict method.

```{r predict, warning=FALSE}

p <- rf$predict(x = titanic[-1]) ## All Development Records
k <- rf$predict(kfold = TRUE) ## Validation
p_gbm <- predict(mod, titanic[-1], n.trees = gbm.perf(mod, plot.it = F))

roc_dev <- pROC::roc(titanic$Survived, -p)
roc_val <- pROC::roc(titanic$Survived, -k)
roc_gbm <- pROC::roc(titanic$Survived, -p_gbm)

plot(roc_dev)
par(new=TRUE)
plot(roc_val, col="red")
par(new=TRUE)
plot(roc_gbm, col="blue")

```


### Predicting on New Data

```{r new-data}
v <- rf$ensemble$mod$var.names
p_sample <- rf$predict(x=head(titanic)[v])
p_sample
```

### Exporting SAS Code

```{r, export-to-sas}
f <- tempfile(fileext = "sas")
rf$generate_sas_code(file=f, pfx="mod1")
```

Code sample of first and last 6 lines:

```{r, export-to-sas2, echo=FALSE, results='hold'}
cat(head(readLines(f)), sep="\n")
cat("\n...\n\n")
cat(tail(readLines(f)), sep="\n")
```