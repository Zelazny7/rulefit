---
title: "README"
author: "Eric Graves"
date: "July 10, 2017"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rulefit)
data(titanic, package="binnr")
```

## Installation

```{r install, eval=FALSE}
devtools::install_git("https://GravesEE@gitlab.ins.risk.regn.net/minneapolis-r-packages/rulefit.git")
```

## Usage

### Creating a RuleFit Model

A RuleFit model uses a tree ensemble to generate its rules. As such, a tree 
ensemble model must be provided to the rulefit function. This funciton returns
a RuleFit object which can be used to mine rules and train rule ensembles.

```{r constructor, warning=FALSE}

mod <- gbm.fit(titanic[-1], titanic$Survived, distribution="bernoulli",
  interaction.depth=3, shrinkage=0.1, verbose = FALSE)

rf <- rulefit(mod)

class(rf)
```

### Training

Training a RuleFit model is as easy as calling the train method. This is a
Reference Class object like those in `binnr` which means functions are
"attached" to the object itself. The train method uses the `cv.glmnet` function
from the `glmnet` package and accepts all of the same arguments.

##### Common Arguments
Argument | Purpose
---|---
x | Dataset of predictors that should match what was used for training the ensemble.
y | Target variable to train against.
family | What is the distribution of the target? Binomial for 0/1 variables.
keep | TRUE/FALSE for whether to keep the out-of-fold predictions. Useful for validation.
alpha | Penatly mixing parameter. LASSO regression uses the default of 0.
nfolds | How many k-folds to train the model with. Defaults to 5.
dfmax | How many variables should the final model have?

```{r train}
rf$train(x=titanic[-1], y = titanic$Survived, family="binomial", keep=TRUE, nfolds=10)
```

The train method first creates hundreds of rules from the tree ensemble. Each
rule is a path through a single decision tree and represents the conjunction
of logical statments. Here are a few of the candidate rules printed in pseudo-
code.

```{r}
head(rf$rules, 1)

tail(rf$rules, 1)
```

### Predicting

Once a RuleFit model is trained. Predictions can be produced by calling the 
predict method.

```{r predict, warning=FALSE}

p <- rf$predict(x = titanic[-1]) ## All Development Records
k <- rf$predict(kfold = TRUE) ## Validation
p_gbm <- predict(mod, titanic[-1], n.trees = gbm.perf(mod, plot.it = F))

roc_dev <- pROC::roc(titanic$Survived, -p)
roc_val <- pROC::roc(titanic$Survived, -k)
roc_gbm <- pROC::roc(titanic$Survived, -p_gbm)

plot(roc_dev)
par(new=TRUE)
plot(roc_val, col="red")
par(new=TRUE)
plot(roc_gbm, col="blue")

```


### Predicting on New Data

```{r new-data}
v <- rf$ensemble$mod$var.names
p_sample <- rf$predict(x=head(titanic)[v])
p_sample
```

### Exporting SAS Code

```{r, export-to-sas}
f <- tempfile(fileext = "sas")
rf$generate_sas_code(file=f, pfx="mod1")
```

Code sample of first and last 6 lines:

```{r, export-to-sas2, echo=FALSE, results='hold'}
cat(head(readLines(f)), sep="\n")
cat("\n...\n\n")
cat(tail(readLines(f)), sep="\n")
```

### Using RuleFit with Binnr

```{r, binnr, results='hide'}

rules <- rf$ensemble$predict_sparse_nodes(titanic[-1])
rules <- as.matrix(rules[,rf$rids])

### create binnr model
library(binnr)
x <- cbind(titanic, rules)
b <- bin(x, titanic$Survived)

cl <- b$cluster()
to_drop <- b$prune_clusters(cl, corr = 0.90, 1)
b$drop(to_drop)

b$fit("model1", "model with RuleFit rules", overwrite = TRUE)

to_drop <- setdiff(names(x), names(titanic))
b$drop(to_drop)
b$fit("model2", "model with no rules")
```

### Top Rules adding to binnr model

```{r, toprules}
b$select("model1")
b$sort()
toprules <- as.integer(row.names(head(b$summary(), 10)))
rf$rules[toprules[!is.na(toprules)]]
```

### RuleFit and Binnr Lift

RuleFit models can be used to extract nodes and use them alongside traditional
modeling methods such as logistic regression. Here, supplementing the original
dataset with RuleFit rules adds considerable lift.

```{r, compare-methods}

## Extract the unbiased, K-Fold predictions from the binnr models
fit1 <- b$models$model1@fit
p_binnr_rules <- fit1$fit.preval[,which.min(fit1$cvm)]

fit2 <- b$models$model2@fit
p_binnr_alone <- fit2$fit.preval[,which.min(fit2$cvm)]

roc_binnr_rules <- pROC::roc(titanic$Survived, -p_binnr_rules)
roc_binnr_alone <- pROC::roc(titanic$Survived, -p_binnr_alone)

plot(roc_binnr_alone)
par(new=TRUE)
plot(roc_binnr_rules, col="red")
par(new=TRUE)
```